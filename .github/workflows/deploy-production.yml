name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: hotel-reservation-api
  ECS_CLUSTER: hotel-reservation-system-api-ecs-cluster
  ECS_SERVICE: hotel-reservation-system-api-task-service-l9hf8pok
  CONTAINER_NAME: hotel-reservation-system-api

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        working-directory: backend
        run: |
          echo "üß™ Running tests..."
          mvn clean test -B
          echo "‚úÖ Tests passed!"

      - name: Build application
        working-directory: backend
        run: |
          echo "üî® Building application..."
          mvn package -DskipTests -B
          echo "‚úÖ Build successful!"

      - name: Extract version
        id: meta
        run: |
          VERSION=$(mvn -f backend/pom.xml help:evaluate -Dexpression=project.version -q -DforceStdout)
          GIT_HASH=$(git rev-parse --short HEAD)
          TAG="${VERSION}-${GIT_HASH}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${TAG}"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-${{ steps.meta.outputs.tag }}
          path: backend/target/*.jar

  build-docker-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test

    outputs:
      image-uri: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.build-and-test.outputs.tag }}
        run: |
          echo "üê≥ Building Docker image..."
          cd backend

          # Build and push with multiple tags
          docker buildx build \
            --platform linux/amd64 \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA \
            --push \
            .

          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "‚úÖ Image pushed: $IMAGE_URI"

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build-image.outputs.image }}
          format: 'table'
          exit-code: '0'  # Don't fail on vulnerabilities, just report
          severity: 'CRITICAL,HIGH'

  deploy-to-aws:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker-image]
    environment:
      name: production
      url: https://api.yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download current task definition
        id: download-taskdef
        run: |
          echo "üì• Downloading current task definition..."
          aws ecs describe-task-definition \
            --task-definition $ECS_SERVICE \
            --query taskDefinition > task-definition.json

          # Remove fields that can't be used in registration
          cat task-definition.json | jq 'del(
            .taskDefinitionArn,
            .requiresAttributes,
            .compatibilities,
            .revision,
            .status,
            .registeredAt,
            .registeredBy
          )' > task-def-clean.json

          echo "‚úÖ Task definition downloaded"
          echo "üìã Task definition preview:"
          cat task-def-clean.json | jq '.containerDefinitions[0] | {name, image, secrets: .secrets | length}'

      - name: Fill in the new image ID in the task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def-clean.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ needs.build-docker-image.outputs.image-uri }}

      - name: Deploy to Amazon ECS
        id: deploy-ecs
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 10

      - name: Verify deployment
        id: verify
        run: |
          echo "üîç Verifying deployment..."

          # Check service status
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].status' \
            --output text)

          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].runningCount' \
            --output text)

          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].desiredCount' \
            --output text)

          echo "Service Status: $SERVICE_STATUS"
          echo "Running Tasks: $RUNNING_COUNT/$DESIRED_COUNT"

          if [ "$RUNNING_COUNT" -eq "$DESIRED_COUNT" ]; then
            echo "‚úÖ Deployment verified successfully!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Deployment verification failed!"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get load balancer endpoint
        id: get-endpoint
        run: |
          TG_ARN=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].loadBalancers[0].targetGroupArn' \
            --output text)

          if [ "$TG_ARN" != "None" ]; then
            LB_ARN=$(aws elbv2 describe-target-groups \
              --target-group-arns $TG_ARN \
              --query 'TargetGroups[0].LoadBalancerArns[0]' \
              --output text)

            ALB_DNS=$(aws elbv2 describe-load-balancers \
              --load-balancer-arns $LB_ARN \
              --query 'LoadBalancers[0].DNSName' \
              --output text)

            echo "endpoint=https://$ALB_DNS" >> $GITHUB_OUTPUT
          fi

      - name: Test health endpoint
        run: |
          ENDPOINT="${{ steps.get-endpoint.outputs.endpoint }}"
          if [ -n "$ENDPOINT" ]; then
            echo "üè• Testing health endpoint: $ENDPOINT/actuator/health"
            sleep 30  # Wait for service to be ready

            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT/actuator/health" || echo "000")

            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ö†Ô∏è  Health check returned: $RESPONSE"
            fi
          fi

      - name: Create deployment tag
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          TAG_NAME="prod-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG_NAME" -m "Production deployment $(date)"
          git push origin "$TAG_NAME" || echo "Tag push failed, continuing..."

  notify-deployment:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, build-docker-image, deploy-to-aws]
    if: always()

    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.deploy-to-aws.result }}" = "success" ]; then
            echo "status=‚úÖ SUCCESS" >> $GITHUB_OUTPUT
            echo "color=28a745" >> $GITHUB_OUTPUT
            echo "message=Deployment completed successfully!" >> $GITHUB_OUTPUT
          else
            echo "status=‚ùå FAILED" >> $GITHUB_OUTPUT
            echo "color=d73a49" >> $GITHUB_OUTPUT
            echo "message=Deployment failed! Please check the logs." >> $GITHUB_OUTPUT
          fi

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "${{ steps.status.outputs.status }} - Hotel Reservation Backend Deployment"
          to: ${{ secrets.DEPLOYMENT_EMAIL }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #${{ steps.status.outputs.color }}; color: white; padding: 20px; border-radius: 5px; }
                .content { background: #f4f4f4; padding: 20px; margin-top: 20px; border-radius: 5px; }
                .details { background: white; padding: 15px; margin-top: 10px; border-left: 4px solid #${{ steps.status.outputs.color }}; }
                .footer { margin-top: 20px; padding: 10px; text-align: center; color: #666; font-size: 12px; }
                .status { font-size: 24px; font-weight: bold; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                td { padding: 8px; border-bottom: 1px solid #ddd; }
                td:first-child { font-weight: bold; width: 150px; }
                .success { color: #28a745; }
                .failed { color: #d73a49; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>üöÄ Hotel Reservation System</h1>
                  <p class="status">${{ steps.status.outputs.status }}</p>
                </div>

                <div class="content">
                  <h2>Deployment Summary</h2>
                  <p>${{ steps.status.outputs.message }}</p>

                  <div class="details">
                    <h3>Deployment Details</h3>
                    <table>
                      <tr>
                        <td>Environment:</td>
                        <td><strong>Production (AWS ECS)</strong></td>
                      </tr>
                      <tr>
                        <td>Repository:</td>
                        <td>${{ github.repository }}</td>
                      </tr>
                      <tr>
                        <td>Branch:</td>
                        <td><strong>${{ github.ref_name }}</strong></td>
                      </tr>
                      <tr>
                        <td>Commit:</td>
                        <td><code>${{ github.sha }}</code></td>
                      </tr>
                      <tr>
                        <td>Triggered by:</td>
                        <td>${{ github.actor }}</td>
                      </tr>
                      <tr>
                        <td>Build Status:</td>
                        <td class="${{ needs.build-and-test.result }}">${{ needs.build-and-test.result }}</td>
                      </tr>
                      <tr>
                        <td>Docker Build:</td>
                        <td class="${{ needs.build-docker-image.result }}">${{ needs.build-docker-image.result }}</td>
                      </tr>
                      <tr>
                        <td>Deployment:</td>
                        <td class="${{ needs.deploy-to-aws.result }}">${{ needs.deploy-to-aws.result }}</td>
                      </tr>
                      <tr>
                        <td>Timestamp:</td>
                        <td>${{ github.event.head_commit.timestamp }}</td>
                      </tr>
                      <tr>
                        <td>Commit Message:</td>
                        <td><em>${{ github.event.head_commit.message }}</em></td>
                      </tr>
                    </table>
                  </div>

                  <div class="details" style="margin-top: 15px;">
                    <h3>üìä Quick Links</h3>
                    <ul>
                      <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></li>
                      <li><a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">View Commit</a></li>
                      <li><a href="https://console.aws.amazon.com/ecs/home?region=${{ env.AWS_REGION }}#/clusters/${{ env.ECS_CLUSTER }}/services/${{ env.ECS_SERVICE }}">View ECS Service</a></li>
                    </ul>
                  </div>

                  ${{ needs.deploy-to-aws.result == 'success' && '<div class="details" style="margin-top: 15px; background: #d4edda; border-color: #28a745;"><h3>‚úÖ Next Steps</h3><ul><li>Application is now live in production</li><li>Monitor CloudWatch logs for any issues</li><li>Run smoke tests to verify functionality</li></ul></div>' || '' }}

                  ${{ needs.deploy-to-aws.result == 'failure' && '<div class="details" style="margin-top: 15px; background: #f8d7da; border-color: #d73a49;"><h3>‚ùå Action Required</h3><ul><li>Check the workflow logs for error details</li><li>Verify AWS credentials and permissions</li><li>Review recent code changes for issues</li><li>Contact DevOps if problem persists</li></ul></div>' || '' }}
                </div>

                <div class="footer">
                  <p>This is an automated message from GitHub Actions</p>
                  <p>Hotel Reservation System - Backend Deployment</p>
                </div>
              </div>
            </body>
            </html>

      - name: Send Slack notification (optional)
        if: always() && secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy-to-aws.result }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            Deployment ${{ steps.status.outputs.status }}
            Environment: Production
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

  rollback:
    name: Automatic Rollback
    runs-on: ubuntu-latest
    needs: [deploy-to-aws]
    if: failure()

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback to previous version
        run: |
          echo "‚ö†Ô∏è  Deployment failed, initiating rollback..."

          # Get current and previous task definitions
          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].taskDefinition' \
            --output text)

          CURRENT_REVISION=$(echo $CURRENT_TASK_DEF | grep -o '[0-9]*$')
          PREVIOUS_REVISION=$((CURRENT_REVISION - 1))

          if [ $PREVIOUS_REVISION -gt 0 ]; then
            TASK_FAMILY=$(echo $CURRENT_TASK_DEF | sed 's/:[0-9]*$//')
            PREVIOUS_TASK_DEF="${TASK_FAMILY}:${PREVIOUS_REVISION}"

            echo "Rolling back to: $PREVIOUS_TASK_DEF"

            aws ecs update-service \
              --cluster $ECS_CLUSTER \
              --service $ECS_SERVICE \
              --task-definition $PREVIOUS_TASK_DEF \
              --force-new-deployment

            echo "‚úÖ Rollback initiated to revision $PREVIOUS_REVISION"
          else
            echo "‚ö†Ô∏è  No previous version to rollback to"
          fi
